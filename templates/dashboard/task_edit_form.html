<form method="post" enctype="multipart/form-data"
      action="/dashboard/tasks/edit/{{ task.id }}/">
{% csrf_token %}

<div class="row g-3">

    <!-- CUSTOMER -->
    <div class="col-md-6">
        <label class="form-label">Customer Name</label>
        <input type="text" name="cust_name" class="form-control" value="{{ task.cust_name }}" required>
    </div>

    <div class="col-md-6">
        <label class="form-label">Phone</label>
        <input type="text" name="cust_phone" class="form-control" value="{{ task.cust_phone }}" required pattern="\d{10}" maxlength="10">
    </div>

    <!-- WhatsApp Number + Same as Phone (Compact Row) -->
    <div class="col-md-6">
        <label class="form-label">WhatsApp Number</label>
        <div class="input-group">
            <input type="text" name="cust_whatsapp" class="form-control"
                    required pattern="\d{10}" maxlength="10" placeholder="WhatsApp Number" value="{{ task.cust_whatsapp }}">

            <div class="input-group-text">
                <input class="form-check-input mt-0" 
                        type="checkbox" 
                        id="sameWhatsappCheck" 
                        title="Same as Phone Number">
            </div>
        </div>
        <small class="text-muted">Check to copy phone number</small>
    </div>

    <div class="col-md-6">
        <label class="form-label">Pincode</label>
        <input type="text" name="pincode" class="form-control" value="{{ task.pincode }}" required pattern="\d{6}" maxlength="6">
    </div>

    <div class="col-12">
        <label class="form-label">Location</label>
        <textarea name="cust_location" class="form-control" required>{{ task.cust_location }}</textarea>
    </div>

    <!-- CATEGORY -->
    <div class="col-md-6">
        <label class="form-label">Category</label>
        <select name="category" class="form-select" required>
            <option value="">Select Category</option>
            {% for cat in categories %}
                {% if cat.category_type == "primary" %}
                <option value="{{ cat.id }}" {% if task.category and task.category.id == cat.id %}selected{% endif %}>
                    {{ cat.name }}
                </option>
                {% endif %}
            {% endfor %}
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">Subcategories</label>
        <select name="subcategories" id="subcategorySelect" class="form-select" multiple>
            {% for sc in categories %}
                <option value="{{ sc.id }}"
                    {% if sc in task.subcategories.all %}selected{% endif %}>
                    {{ sc.name }}
                </option>
            {% endfor %}
        </select>
        <small class="text-muted">Ctrl+Click to select multiple</small>
    </div>


    <div class="col-12">
        <label class="form-label">Additional Info</label>
        <textarea name="additional_info" class="form-control">{{ task.additional_info }}</textarea>
    </div>

    <!-- IMAGE -->
    <div class="col-12">
        <label class="form-label">Task Image</label><br>
        {% if task.task_image %}
            <img src="{{ task.task_image.url }}" width="150" class="mb-2 rounded">
        {% endif %}
        <input type="file" name="task_image" class="form-control">
    </div>

    <!-- WORKER -->
    <input type="hidden" name="worker" value="{{ task.worker.id|default_if_none:'' }}">


    <div class="col-md-6">
        <label class="form-label">Assigned Worker</label>
        <input type="text" name="worker_display" class="form-control"
               value="{% if task.worker %}{{ task.worker.name }}{% endif %}" readonly>
    </div>

    <div class="col-md-6">
        <label class="form-label">Worker Phone</label>
        <input type="text" name="worker_phone" class="form-control"
               value="{{ task.worker_phone }}" readonly>
    </div>

    <div class="col-md-6">
        <label class="form-label">Worker Category</label>
        <input type="text" name="worker_category" class="form-control"
               value="{{ task.worker_category }}" readonly>
    </div>

    <div class="col-md-4 mt-1">
        <button type="button" onclick="openAssignWorkerModal()" class="btn btn-outline-primary w-100">
            Change Worker
        </button>
    </div>

    <!-- SCHEDULE -->
    <div class="col-md-6">
        <label>Schedule Date</label>
        <input type="datetime-local" name="schedule_date"
               value="{{ task.schedule_date|date:'Y-m-d\\TH:i' }}"
               class="form-control">
    </div>

    <div class="col-md-6">
        <label>Service Done Date</label>
        <input type="date" name="day_service_done"
               value="{{ task.day_service_done|date:'Y-m-d' }}"
               class="form-control">
    </div>

    <!-- STATUS -->
    <div class="col-md-6">
        <label>Status</label>
        <select name="status" class="form-select">
            {% for key,label in task.STATUS_CHOICES %}
                <option value="{{ key }}" {% if task.status == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- PAYMENT & FEEDBACK -->
    <div class="col-md-6">
        <label>Payment Received</label>
        <input type="number" step="0.01" name="payment_received_amt"
               class="form-control" value="{{ task.payment_received_amt }}">
    </div>

    <div class="col-md-6">
        <label>Rating (0â€“5)</label>
        <input name="rating" type="number" step="1" min="0" max="5"
               class="form-control" value="{{ task.rating }}">
    </div>

    <div class="col-12">
        <label>Feedback</label>
        <textarea name="feedback" class="form-control">{{ task.feedback }}</textarea>
    </div>

    <div class="col-12">
        <button class="btn btn-primary w-100 mt-3">Save Changes</button>
    </div>
</div>
</form>
