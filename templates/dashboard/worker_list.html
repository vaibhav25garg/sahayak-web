{% extends 'dashboard/base.html' %}
{% block content %}

<style>
/* ---------------- Horizontal Scroll Table ---------------- */
.table-horizontal-scroll {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    padding-bottom: 5px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
}

.table-horizontal-scroll thead th {
    position: sticky;
    top: 0;
    background: #212529;
    color: white;
    z-index: 2;
}

.table-horizontal-scroll td,
.table-horizontal-scroll th {
    white-space: nowrap;
    padding: 8px 15px;
}

.table-horizontal-scroll::-webkit-scrollbar {
    height: 8px;
}
.table-horizontal-scroll::-webkit-scrollbar-thumb {
    background: #aaa;
    border-radius: 10px;
}
.table-horizontal-scroll::-webkit-scrollbar-thumb:hover {
    background: #888;
}
</style>

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ðŸ‘· Worker Management</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWorkerModal">+ Add Worker</button>
    </div>

    <!-- Filters -->
    <form method="get" class="row g-3 mb-3">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" value="{{ search_query }}" placeholder="Search by name or phone">
        </div>

        <div class="col-md-3">
            <select name="category" class="form-select">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <select name="status" class="form-select">
                <option value="">All Status</option>
                <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="verified" {% if selected_status == 'verified' %}selected{% endif %}>Verified</option>
                <option value="rejected" {% if selected_status == 'rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-secondary w-100">Filter</button>
        </div>
    </form>

    <!-- Worker Table -->
    <div class="table-horizontal-scroll">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Number</th>
                    <th>Category</th>
                    <th>Age</th>
                    <th>Score</th>
                    <th>Verify Status</th>
                    <th>Registration Date</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for w in workers %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ w.name }}</td>
                    <td>{{ w.phone }}</td>
                    <td>{{ w.primary_category }}</td>
                    <td>{{ w.age }}</td>
                    <td>{{ w.ranking_score }}</td>

                    <td>
                        <span class="badge 
                            {% if w.verification_status == 'verified' %}bg-success
                            {% elif w.verification_status == 'pending' %}bg-warning
                            {% else %}bg-danger
                            {% endif %}">
                            {{ w.verification_status|title }}
                        </span>
                    </td>

                    <td>
                      <p>{{ w.created_at|date:"d M Y, h:i A" }}</p>
                    </td>

                    <td>
                        <div class="btn-group">
                            <a href="{% url 'dashboard:worker_detail' w.id %}" class="btn btn-sm btn-info">View</a>
                            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editWorkerModal{{ w.id }}">Edit</button>
                            <a href="{% url 'dashboard:worker_delete' w.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete Worker?')">Delete</a>
                            <a href="{% url 'dashboard:worker_pdf' w.id %}" class="btn btn-sm btn-secondary">PDF</a>
                        </div>
                    </td>
                </tr>

                <!-- EDIT WORKER MODAL -->
                <div class="modal fade" id="editWorkerModal{{ w.id }}" tabindex="-1">
                  <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4">

                      <div class="modal-header bg-light px-4 py-3">
                        <h5 class="modal-title text-primary">
                          <i class="fas fa-user-edit me-2"></i> Update Worker - {{ w.name }}
                        </h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                      </div>

                      <form method="POST" enctype="multipart/form-data"
                            action="{% url 'dashboard:worker_edit' w.id %}"
                            class="px-4 pt-4 pb-3">
                        {% csrf_token %}

                        <div class="row g-4">

                          <!-- LEFT SIDE -->
                          <div class="col-md-6">

                            <div class="form-floating mb-3">
                              <input type="text" class="form-control" name="name" value="{{ w.name }}" required>
                              <label>Name</label>
                            </div>

                            <div class="form-floating mb-3">
                              <input type="text" class="form-control" name="phone" value="{{ w.phone }}" required>
                              <label>Phone</label>
                            </div>

                            <div class="form-floating mb-3">
                              <input type="text" class="form-control" name="whatsapp_no" value="{{ w.whatsapp_no }}">
                              <label>WhatsApp Number</label>
                            </div>

                            <div class="form-floating mb-3">
                              <input type="number" class="form-control" name="age" value="{{ w.age }}">
                              <label>Age</label>
                            </div>

                            <div class="form-floating mb-3">
                              <input type="text" class="form-control" name="aadhar_no" value="{{ w.aadhar_no }}">
                              <label>Aadhaar Number</label>
                            </div>

                            <div class="form-floating mb-3">
                              <input type="url" class="form-control" name="geo_location_link" value="{{ w.geo_location_link }}">
                              <label>Geo Location Link</label>
                            </div>

                          </div>

                          <!-- RIGHT SIDE -->
                          <div class="col-md-6">

                            <div class="form-floating mb-3">
                              <select class="form-select" name="primary_category" required>
                                {% for c in categories %}
                                <option value="{{ c.id }}" {% if w.primary_category and w.primary_category.id == c.id %}selected{% endif %}>
                                  {{ c.name }}
                                </option>
                                {% endfor %}
                              </select>
                              <label>Primary Category</label>
                            </div>

                           <div class="mb-3">
                            <label class="form-label fw-semibold">Secondary Categories</label>
                            <select name="secondary_categories" class="form-select" multiple>

                             {% for c in subcategories %}
                              <option value="{{ c.id }}" {% if c in w.secondary_categories.all %}selected{% endif %}>
                                  {{ c.name }}
                              </option>
                              {% endfor %}

                            </select>
                            <small>Select multiple subcategories</small>
                          </div>

                          <div class="form-floating mb-3">
                            <input 
                                type="text" 
                                class="form-control" 
                                name="location" 
                                value="{{ w.location.street_address }}" 
                                placeholder="Enter Location"
                            >
                            <label>Location</label>
                        </div>


                            <div class="form-floating mb-3">
                              <select class="form-select" name="verification_status">
                                {% for key, label in w.VERIFICATION_STATUS %}
                                <option value="{{ key }}" {% if w.verification_status == key %}selected{% endif %}>
                                  {{ label }}
                                </option>
                                {% endfor %}
                              </select>
                              <label>Verification Status</label>
                            </div>

                            <div class="form-floating mb-3">
                              <input type="number" step="0.01" class="form-control"
                                    name="ranking_score" value="{{ w.ranking_score }}">
                              <label>Ranking Score</label>
                            </div>

                          </div>

                          <!-- FILE UPLOAD SECTION -->
                          <hr class="mt-4">

                          <h5 class="mt-3 mb-2 fw-bold">Documents</h5>

                          <div class="col-md-4">
                            <label class="form-label">Aadhar Front</label><br>
                            {% if w.aadhar_img_front %}
                              <img src="{{ w.aadhar_img_front.url }}" class="img-fluid mb-2 rounded" style="max-height:120px;">
                            {% endif %}
                            <input type="file" name="aadhar_img_front" class="form-control">
                          </div>

                          <div class="col-md-4">
                            <label class="form-label">Aadhar Back</label><br>
                            {% if w.aadhar_img_back %}
                              <img src="{{ w.aadhar_img_back.url }}" class="img-fluid mb-2 rounded" style="max-height:120px;">
                            {% endif %}
                            <input type="file" name="aadhar_img_back" class="form-control">
                          </div>

                          <div class="col-md-4">
                            <label class="form-label">Selfie</label><br>
                            {% if w.selfie_img %}
                              <img src="{{ w.selfie_img.url }}" class="img-fluid mb-2 rounded" style="max-height:120px;">
                            {% endif %}
                            <input type="file" name="selfie_img" class="form-control">
                          </div>

                        </div>

                        <div class="modal-footer border-0 mt-3 px-4">
                          <button type="submit" class="btn btn-primary px-4 py-2">
                            Save Changes
                          </button>
                        </div>

                      </form>

                    </div>
                  </div>
                </div>


                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ADD WORKER MODAL -->
<div class="modal fade" id="addWorkerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form method="POST" enctype="multipart/form-data" action="{% url 'dashboard:worker_add' %}">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title">Add New Worker</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-2">

                        <!-- NAME -->
                        <div class="col-md-6">
                            <input type="text" name="name" class="form-control" placeholder="Full Name" required>
                        </div>

                        <!-- PHONE -->
                        <div class="col-md-6">
                            <input type="text" name="phone" class="form-control" placeholder="Phone Number" required>
                        </div>

                        <!-- WHATSAPP -->
                        <div class="col-md-6">
                            <input type="text" name="whatsapp_no" class="form-control" placeholder="Whatsapp Number">
                        </div>

                        <!-- AGE -->
                        <div class="col-md-6">
                            <input type="number" name="age" class="form-control" placeholder="Age">
                        </div>

                       <!-- ADDRESS -->
                        <div class="col-md-12">
                            <textarea name="address" class="form-control" placeholder="House No, Street, Area"></textarea>
                        </div>

                        <!-- AADHAR NUMBER -->
                        <div class="col-md-6">
                            <input type="text" name="aadhar_no" class="form-control" placeholder="Aadhaar Number">
                        </div>

                        <!-- GEO LOCATION -->
                        <div class="col-md-6">
                            <input type="url" name="geo_location_link" class="form-control" placeholder="Geo Location (Google Map Link)">
                        </div>

                        <!-- PRIMARY CATEGORY -->
                        <div class="col-md-6">
                            <select name="primary_category" class="form-select" required>
                                <option value="">Select Category</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- VERIFICATION STATUS -->
                        <div class="col-md-6">
                            <select name="verification_status" class="form-select">
                                <option value="pending">Pending</option>
                                <option value="verified">Verified</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>

                        <!-- LOCATION -->
                        <div class="col-md-6">
                            <select name="location" class="form-select">
                                <option value="">Select Location</option>
                                {% for loc in locations %}
                                <option value="{{ loc.id }}">{{ loc.area_code }} - {{ loc.city }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- RANKING SCORE -->
                        <div class="col-md-6">
                            <input type="number" step="0.01" name="ranking_score" class="form-control" placeholder="Ranking Score">
                        </div>

                        <!-- DOCUMENTS -->
                        <div class="col-md-6">
                            <label>Aadhaar Front:</label>
                            <input type="file" name="aadhar_img_front" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label>Aadhaar Back:</label>
                            <input type="file" name="aadhar_img_back" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label>Selfie:</label>
                            <input type="file" name="selfie_img" class="form-control">
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary">Save</button>
                </div>

            </form>

        </div>
    </div>
</div>

{% endblock %}
